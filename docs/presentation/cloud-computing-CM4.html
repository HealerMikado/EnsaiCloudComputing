<!doctype html>
<html>

<head>
    <meta charset="utf-8">

    <title>Cloud Computing, CM4</title>

    <meta name="description" content="Cloud Computing CM4 : comment stocker des donn√©es dans le cloud.">
    <meta name="author" content="R√©mi P√©pin">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/mine.css">
    <link rel="stylesheet" href="dist/theme/solarized.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css">
</head>

<body>
    <div class="reveal">
        <div class="slides">

            <section>
                <section>
                    <h1>Cloud Computing, CM4</h1>
                    <h2>Stockage de donn√©es dans le Cloud</h2>
                    <p>P√©pin R√©mi, Ensai, 2024</p>
                    <p>remi.pepin@insee.fr</p>
                </section>
            </section>

            <section>
                <section>
                    <h2>Le stockage de donn√©es dans le cloud</h2>
                </section>
                <section>
                    <h3>Les diff√©rents services de stockage</h3>
                    <img src="https://media.giphy.com/media/lKXEBR8m1jWso/giphy.gif"
                        alt="" class="w60">
                </section>

                <section>
                    <h3>Les diff√©rents services de stockage 1/2</h3>
                    <ul>
                        <li><span class="important">Stockage block :</span> donn√©es
                            directement sur un disque dur (SSH/HDD). Pour stocker des
                            donn√©es pour une VM. AWS EBS, GCP Persistent Disk</li>
                        <li><span class="important">Stockage r√©seau :</span> donn√©es sur
                            un stockage partag√© entre plusieurs VM. Pensez aux dossiers
                            partag√©s de l'Ensai. AWS EFS, GCP Filestore, Azure Files</li>
                        <li><span class="important">Stockage objet :</span> donn√©es
                            stock√©es sur des serveurs distants. Pas de point de montage sur
                            la machine. Fichiers accessibles via API REST. AWS S3,
                            GCP Cloud Storage, Azure Blob Storage</li>
                    </ul>
                </section>
                <section>
                    <h3>Les diff√©rents services de stockage 2/2</h3>
                    <ul>
                        <li><span class="important">Base de donn√©es relationnelle :
                            </span> pour des donn√©es tabulaires. On ne stocke plus un
                            fichier mais des donn√©es structur√©es et on utilise SQL pour
                            les requ√™ter. Possibilit√© de faire des jointures. AWS RDS, GCP
                            Cloud SQL</li>
                        <li><span class="important">Base de donn√©es no-SQL :</span> pour
                            des donn√©es semi structur√©es voir non structur√©es. Interaction
                            avec les donn√©es possibles, par contre plus de jointure en g√©n√©ral. AWS
                            DynamoDB, GCP Big Table</li>
                        <li><span class="important">Cache :</span> les donn√©es sont
                            stock√©es en RAM et plus sur disque. Assure une grande
                            performance, par contre les donn√©es peuvent √™tre perdues.
                            Uniquement pour acc√©l√©rer l'acc√®s √† des donn√©es. AWS
                            Elasticache, GCP Memorystore, Azure Cache</li>
                    </ul>
                </section>
            </section>

            <section>
                <section>
                    <h2>Amazon S3</h2>
                </section>

                <section>
                    <h3>In a nutshell ü•ú</h3>
                    <ul>
                        <li>Stockage <em>illimit√©</em> (üí∞üí∞)</li>
                        <li>Stockage non structur√© (image, vid√©o, texte ...)</li>
                        <li>5TB max par objet</li>
                        <li>Objet accessible via API Rest (identifiant unique par objet)
                        </li>
                        <li>Possibilit√© de versionner et chiffrer les objets</li>
                        <li>Gestion fine des acc√®s</li>
                        <li>Diff√©rents niveaux de stockage (de fr√©quent √† archive) pour
                            diff√©rents cas d'utilisation</li>
                    </ul>

                </section>

                <section>
                    <h3>Les avantages</h3>
                    <div class="container">
                        <div class="col">
                            <ul>
                                <li><span class="important">Durabilit√© :</span>
                                    99,999999999 (onze 9).</li>
                                <li><span class="important">Disponibilit√© :</span> les
                                    donn√©es sont toujours accessible via Internet. &lt 60
                                    minutes de downtime par an</li>
                                <li><span class="important">Passage √† l'√©chelle :</span>
                                    stockage <em>infini</em></li>
                                <li><span class="important">S√©curit√© :</span> chiffrement,
                                    gestion des droits fin </li>
                                <li><span class="important">Performance :</span> peut
                                    g√©rer un grand nombre de requ√™tes, s'ins√®re
                                    parfaitement dans l'√©cosyst√®me AWS</li>
                            </ul>
                        </div>
                        <div class="col">
                            <ul>
                                <li><span class="important">Traitement des donn√©es :
                                    </span>avec AWS Glue et Amazon Athena, S3 devient
                                    un data lake (on peut requ√™ter les donn√©es)</li>
                                <li><span class="important">Cycle de vie :</span> les
                                    donn√©es peuvent √™tre supprim√©es automatiquement, passer
                                    dans un autre niveau de stockage et versionn√©es si
                                    besoin.</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section>
                    <h3>Les niveaux de stockage</h3>
                    <ol>
                        <li><span class="important">S3 standard :</span> meilleures
                            performances, mais le plus cher </li>
                        <li><span class="important">S3 standard IA :</span> pour donn√©es
                            acc√©d√©es rarement. Les m√™mes perfs que S3 standard, moins cher
                            en terme de Go/mois mais l'acc√®s aux donn√©es est plus cher
                        </li>
                        <li><span class="important">S3 One Zone IA :</span> les donn√©es ne
                            sont stock√©es que dans un data center. Moins cher que standard
                            IA, mais les perfs sont inf√©rieures</li>
                        <li><span class="important">S3 Glacier, deep archive:</span> les
                            solutions les moins ch√®res, mais l'acc√®s aux donn√©es est cher
                            et prend du temps</li>
                    </ol>
                </section>

                <section>
                    <h3>Cas d'utilisation</h3>
                    <ul>
                        <li>Stockage pour application : photos pour un r√©seau social par exemple</li>
                        <li>Data Lake : espace de stockage illimit√© peu on√©reux. On connecte 
                            des outils pour traiter les donn√©es</li>
                        <li>Sauvegarde pour donn√©es critiques : chiffrement, disponibilit√©, durabilit√©, droit</li>
                        <li>Archivage de donn√©es : S3 Glacier, deep archive</li>
                        <li>Migration : Snowcone, Snowball</li>
                    </ul>
                </section>

                <section>
                    <img src="https://blog.min.io/content/images/2020/01/DBYNeEPVYAUkN2O.jpeg" alt="">
                </section>

                <section>
                    <h3>S3 et cdkts</h3>
<pre><code class="python" data-trim data-noescape>
from constructs import Construct
from cdktf import App, TerraformStack
from cdktf_cdktf_provider_aws.provider import AwsProvider
from cdktf_cdktf_provider_aws.s3_bucket import S3Bucket

class S3Stack(TerraformStack):
    def __init__(self, scope: Construct, id: str):
        super().__init__(scope, id)

        AwsProvider(self, "AWS", region="us-east-1")

        bucket = S3Bucket(
            self, "s3_bucket",
            bucket_prefix = "my-cdtf-test-bucket",
            acl="private",
            force_destroy=True
        )

app = App()
S3Stack(app, "S3")

app.synth()
</code></pre>
                </section>

                <section>
                    <h3>S3 et python</h3>
<pre><code class="python" data-trim data-noescape>
import boto3
# Create an S3 resource
s3 = boto3.resource('s3')
# Create a bucket
s3.create_bucket(Bucket='mybucket')
# Upload file
with open('/tmp/hello.txt', 'rb') as file:
    s3.Object('mybucket', 'hello_s3.txt').put(Body=file)
# Download file
s3.Bucket('mybucket').download_file('hello_s3.txt', 'hello.txt')
# Delete file
s3.Object('mybucket', 'hello_s3.txt').delete()
</code></pre>
                </section>
            </section>
            <section>
                <section>
                    <h2>DynamoDB</h2>
                </section>

                <section>
                    <h3>In a nutshell ü•ú</h3>
                    <ul>
                        <li>Base de donn√©es No-SQL üëâ<span class="important">cl√©:valeur</span></li>
                        <li>Serverless : pas d'infra √† g√©rer c√¥t√© utilisateur</li>
                        <li>Stockage <em>illimit√©</em> (üí∞üí∞üí∞üí∞üí∞üí∞üí∞üí∞)</li>
                        <li>Paiement du stockage, des op√©rations de lecture et √©criture (RCU, WCU)</li>
                        <li>Passage √† l'√©chelle automatique</li>
                        <li>Gestion fine des acc√®s (uniquement certaines lignes/attributs)</li>
                        <li>R√©plication entre r√©gions possible</li>
                        <li>Peut faire des op√©rations en mode ACID (Atomicit√©, Coh√©rence, Isolation, Durabilit√©)</li>
                    </ul>
                </section>
                <section>
                    <h3>Mod√®le de donn√©es</h3>
                    <img src="img/CM4/dynamoDB.jpg" class="w80" alt="">
                </section>

                <section>
                    <h3>Mod√®le de donn√©es</h3>

                    <ul>
                        <li>Pas de sch√©ma stricte pour les donn√©es. Uniquement partition key d'obligatoire
                             et la sort key si d√©finie</li>
                        <li><span class="important">Partition key :</span> sert √† d√©terminer o√π l'objet sera stock√© (cl√© hashage dans un table de hachage). Si pas de sorted key, 
                            sert de <span class="important">primary key</span></li>
                        <li><span class="important">Sorted key :</span> Permet de trier les donn√©es
                             avec la m√™me partition key. Avec elle, elles d√©finissent la 
                             <span class="important">composite primary key</span>.</li>
                        <li>GET/PUT sur les donn√©es en utilisant la primary key UNIQUEMENT.</li>
                        <li>Possibilit√© d'avoir des indexes secondaires pour requ√™te sur
                             autre attributs (mais üí∞üí∞)</li>
                        <li>AWS g√®re le stockage sur diff√©rentes partitions et augmente leur 
                            nombres si n√©cessaire. Attention aux d√©s√©quilibres.</li>
                    </ul>
                    <div class="important-bloc fragment">M√™me si DynamoDB est serverless, 
                        le service n'est pas brainless. D√©finir une bonne clef primaire permet
                         de meilleurs performance et de r√©duire les co√ªts</div>
                </section>

                <section>
                    <h3>Concevoir une base No SQL</h3>
                    <p>No SQL : pas de sch√©ma, pas de jointure : ne pas penser en model relationnel</p>
                    <div class="important-bloc fragment">Concevoir sa base pour r√©pondre √† des besoins sp√©cifiques (<em>access pattern)</em></div>
                    <ul class="fragment">
                        <li>S'assurer que l'on peut identifier une entit√© (PK)</li>
                        <li>Ne pas avoir peur de mettre plusieurs type d'entit√© par table</li>
                        <li>Limiter les requ√™tes pour r√©pondre √† un besoin</li>
                        <li>Placer des indexes secondaires si besoin</li>
                    </ul>
                    <div class="important-bloc fragment">Au lieu de faire une base "g√©n√©raliste" on va faire une/des bases sp√©cialis√©es</div>
                </section>

                <section>
                    <h3>Cas d'utilisation</h3>
                    <ul>
                        <li>Vente en lignes : Amazon utilise DynamoDB pour les paniers</li>
                        <li>Cache : stockage des √©tats d'un programme</li>
                        <li>Iot : √©tats des objets</li>
                        <li>Jeux vid√©o : leaderboard en temps r√©el</li>
                    </ul>                
                </section>

                <section>
                    <h3>CDKTF et dynamoDB</h3>
                    <pre><code class="python" data-trim data-noescape>
from constructs import Construct
from cdktf import App, TerraformStack
from cdktf_cdktf_provider_aws.provider import AwsProvider
from cdktf_cdktf_provider_aws.dynamodb_table import DynamodbTable, DynamodbTableAttribute

class DynamoDBStack(TerraformStack):
    def __init__(self, scope: Construct, id: str):
        super().__init__(scope, id)

        AwsProvider(self, "AWS", region="us-east-1")

        bucket = DynamodbTable(
            self, "DynamodDB-table",
            name= "user_score",
            hash_key="username",
            range_key="lastename",
            attribute=[
                DynamodbTableAttribute(name="username",type="S" ),
                DynamodbTableAttribute(name="lastename",type="S" )
            ],
            billing_mode="PROVISIONED",
            read_capacity=5,
            write_capacity=5
        )

app = App()
DynamoDBStack(app, "DynamoDBStack")
app.synth()
                    </code></pre>
                </section>
                <section>
                <h3>DynamoDB et python : cr√©ation table</h3>
                <pre><code class="python" data-trim data-noescape>
import boto3
# Get the service resource.
dynamodb = boto3.resource('dynamodb')
# Create the DynamoDB table.
table = dynamodb.create_table(
    TableName='users',
    KeySchema=[
        {'AttributeName': 'username','KeyType': 'HASH'},
        {'AttributeName': 'last_name','KeyType': 'RANGE'}
    ],
    AttributeDefinitions=[
        {'AttributeName': 'username','AttributeType': 'S'},
        {'AttributeName': 'last_name','AttributeType': 'S'},
    ],
    ProvisionedThroughput={'ReadCapacityUnits': 5,'WriteCapacityUnits': 5}
)
# Wait until the table exists.
table.meta.client.get_waiter('table_exists').wait(TableName='users')
                </code></pre>
                </section>
                <section>
                <h3>DynamoDB et python : ajout/suppression √©l√©ment</h3>
                <pre><code class="python" data-trim data-noescape>
import boto3
# Get the service resource.
dynamodb = boto3.resource('dynamodb')
# Get the table.
table = dynamodb.Table('users')
# Put item to the table.
table.put_item(
   Item={
        'username': 'janedoe',
        'first_name': 'Jane',
        'last_name': 'Doe',
        'age': 25,
        'account_type': 'standard_user',
    }
)
# Delete item from the table.
table.delete_item(
    Key={
        'username': 'janedoe',
        'last_name': 'Doe'
    }
)
                </code></pre>
                </section>
                <section>
                    <h3>DynamoDB et python : ajout en batch</h3>
                    <pre><code class="python" data-trim data-noescape>
import boto3
# Get the service resource.
dynamodb = boto3.resource('dynamodb')
# Get the table.
table = dynamodb.Table('users')
# Batch writing item. Only one big query, cost less ans it's quicker
with table.batch_writer() as batch:
for i in range(50):
    batch.put_item(
        Item={
            'account_type': 'anonymous',
            'username': 'user' + str(i),
            'first_name': 'unknown',
            'last_name': 'unknown'
        }
    )
                    </code></pre>
                    </section>
                <section>
                    <h3>DynamoDB et python : r√©cup√©ration d'un objet</h3>
                    <pre><code class="python" data-trim data-noescape>
import boto3
# Get the service resource.
dynamodb = boto3.resource('dynamodb')
# Get the table.
table = dynamodb.Table('users')
# Get item from the table.
response = table.get_item(
    Key={
        'username': 'janedoe',
        'last_name': 'Doe'
    }
)
item = response['Item']
print(item)
                    </code></pre>
                    </section>
                    <section>
                        <h3>DynamoDB et python : modification d'un objet</h3>
                        <pre><code class="python" data-trim data-noescape>
import boto3
# Get the service resource.
dynamodb = boto3.resource('dynamodb')
# Get the table.
table = dynamodb.Table('users')
# Update item from the table.
table.update_item(
    Key={
        'username': 'janedoe',
        'last_name': 'Doe'
    },
    UpdateExpression='SET age = :val1',
    ExpressionAttributeValues={
        ':val1': 26
    }
)
                        </code></pre>
                        </section>
            </section>


            <section>
                <h3>TP S3 - DynamoDB
                </h3>
                <p>Objectif</p>
                <ul>
                    <li>Cr√©er un bucket avec Terraform et interagir avec via Python</li>
                    <li>Cr√©er un une table DynamoDB avec Terraform et interagir avec via Python</li>
                </ul>
            </section>

            <section>
                <img src="https://media.giphy.com/media/xUPOqo6E1XvWXwlCyQ/giphy.gif"
                    alt="" class="plain no-print w60">
            </section>

        </div>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/zoom/zoom.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/search/search.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>

    <script>

        // Also available as an ES module, see:
        // https://revealjs.com/initialization/
        Reveal.initialize({
            controls: true,
            progress: true,
            center: true,
            hash: true,
            viewDistance: 3,
            width: 1600,
            height: 900,
            slideNumber: 'c/t',
            pdfSeparateFragments: false,
            // Learn about plugins: https://revealjs.com/plugins/
            plugins: [RevealZoom, RevealNotes, RevealSearch, RevealHighlight]
        });

    </script>

</body>

</html>